# ECFChecker

This project contains an implementation of a dynamic monitor of the ECF property of Ethereum transactions.
It is based on _[Geth](https://github.com/ethereum/go-ethereum)_, the Go implementation of an Ethereum client, version 1.5.9.

## Artifact description
+ _32bit Ubuntu 16.04 with 1GB RAM._
+ _Prepared on a 64bit Windows host with 32GB RAM and 8 cores, 3.4GHz._
+ _It has go1.6.2 installed._
+ _Credentials are user/pass._

In accordance with the paper, the artifact includes a sample contract ```SimpleDAO``` which is very similar to DAO object in Figure 1.
The ```Mallory``` contract acts as our Attacker object (Figure 3).
Both ```SimpleDAO``` and ```Mallory``` behave as described in the paper. Some deviations are obligatory due to the pecularities of the EVM semantics.

## Running the artifact
Login to the machine, open a terminal and run:

	cd ~/ECFChecker/RunningExample

### Non-ECF example
To run the non-ECF vulnerable ```SimpleDAO``` contract, run:

	./TestScript.sh

The output lines prefixed with ```TestScript :::``` pertain to the test orchestration script, handling creation of new accounts, updating the genesis block, creating a new blockchain, and executing the test script.
The output lines prefixed with ```Test :::``` pertain to running the attack scenario described in the Overview section of the paper. Contracts are created and deployed, and the required transactions are executed.
The rest of the output is generated by the client executable.

Note especially the Before and After messages.
We start with SimpleDAO keeping 4000 wei, 3000 of them are the donator's, the rest is Mallory's. 
Upon sending 1 wei directly to Mallory contract, Mallory's fallback function is invoked and calls SimpleDAO's withdraw(). 
In the first round, Mallory contract receives its 1000 wei back. 
However this triggers again the execution of Mallory's fallback function, which again calls SimpleDAO's withdraw(). 
This repeats 4 times overall, thus after the transaction, SimpleDAO is depleted of all money, and Mallory has 4001 wei.
Indeed, our Checker was able to detect this as non-ECF behavior:

	Transaction is not ECF! Contract 0x0c1108c2149cf9c918d6ca4afeded959f71bcbb1, depth 7, index in transaction starting at 15


### ECF example
To run the fixed ```SimpleDAO``` contract on a similar scenario, run:

	./ECFTestScript.sh

Note that while the output is similar, the final outcome is different.
When Mallory is sent 1 wei, and calls withdraw, only the amount that is registered as Mallory's in SimpleDAO is transferred, as intended by the DAO object.
Remarkably, there is no warning on the transaction being non-ECF.


## Use cases
 - Online verification of the ECF property for new transactions as fetched by the client. Each non-ECF execution recorded is saved in $ETH_FOLDER/ecf.db.
 - Small modifications to the code allow to drop transactions which are not ECF, thus miners could use it to drop non-ECF transactions.
 - In the POPL'18 paper the tool was used to check all transactions since Ethereum's inception until June 23rd 2017.
 - Test specific contracts and executions.
